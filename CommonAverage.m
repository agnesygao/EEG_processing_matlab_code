subject_list={'107','110'};
datafolder = '\\atlas-rstor01.ad.uillinois.edu\research\ELPLab\Experiments\Tone\EEG\ERP_Final\';
numsubject = length(subject_list);

for s=1:numsubject;
    subject = subject_list;
ERP = pop_loaderp( 'filename', [subject '_ERP.erp'], 'filepath', datafolder);
% Add in the left mastoid, call it M1
ERP = pop_erpchanoperator( ERP, {  'ch35 = ch32*-1 Label M1'} , 'ErrorMsg', 'popup', 'Warning', 'on' );

% Re-reference to the common average reference, which includes the 28 scalp channels and the 2 mastoids, but does not include the eye channels
% They get copied over from the original referencing scheme
ERP = pop_erpchanoperator( ERP, {  'nch1 = ch1 - ( avgchan( 1:28,32,35) ) Label FP1',  'nch2 = ch2 - ( avgchan( 1:28,32,35) ) Label FP2',...
  'nch3 = ch3 - ( avgchan( 1:28,32,35) ) Label F7',  'nch4 = ch4 - ( avgchan( 1:28,32,35) ) Label F3',  'nch5 = ch5 - ( avgchan( 1:28,32,35) ) Label Fz',...
  'nch6 = ch6 - ( avgchan( 1:28,32,35) ) Label F4',  'nch7 = ch7 - ( avgchan( 1:28,32,35) ) Label F8',  'nch8 = ch8 - ( avgchan( 1:28,32,35) ) Label FC5',...
  'nch9 = ch9 - ( avgchan( 1:28,32,35) ) Label FC1',  'nch10 = ch10 - ( avgchan( 1:28,32,35) ) Label FC2',...
  'nch11 = ch11 - ( avgchan( 1:28,32,35) ) Label FC6',  'nch12 = ch12 - ( avgchan( 1:28,32,35) ) Label T7',  'nch13 = ch13 - ( avgchan( 1:28,32,35) ) Label C3',...
  'nch14 = ch14 - ( avgchan( 1:28,32,35) ) Label Cz',  'nch15 = ch15 - ( avgchan( 1:28,32,35) ) Label C4',...
  'nch16 = ch16 - ( avgchan( 1:28,32,35) ) Label T8',  'nch17 = ch17 - ( avgchan( 1:28,32,35) ) Label CP5',  'nch18 = ch18 - ( avgchan( 1:28,32,35) ) Label CP1',...
  'nch19 = ch19 - ( avgchan( 1:28,32,35) ) Label CP2',  'nch20 = ch20 - ( avgchan( 1:28,32,35) ) Label CP6',  'nch21 = ch21 - ( avgchan( 1:28,32,35) ) Label P7',...
  'nch22 = ch22 - ( avgchan( 1:28,32,35) ) Label P3',  'nch23 = ch23 - ( avgchan( 1:28,32,35) ) Label Pz',...
  'nch24 = ch24 - ( avgchan( 1:28,32,35) ) Label P4',  'nch25 = ch25 - ( avgchan( 1:28,32,35) ) Label P8',  'nch26 = ch26 - ( avgchan( 1:28,32,35) ) Label O1',...
  'nch27 = ch27 - ( avgchan( 1:28,32,35) ) Label Oz',  'nch28 = ch28 - ( avgchan( 1:28,32,35) ) Label O2',  'nch29 = ch29 Label LO1',...
  'nch30 = ch30 Label LO2',  'nch31 = ch31 Label IO1',  'nch32 = ch32 - ( avgchan( 1:28,32,35) ) Label M2',  'nch33 = ch33 Label VEOG',...
  'nch34 = ch34 Label HEOG',  'nch35 = ch35 - ( avgchan( 1:28,32,35) ) Label M1'} , 'ErrorMsg', 'popup', 'Warning', 'on' );

% Save the new ERPset into the CAR sub-folder of your ERP directory
ERP = pop_savemyerp(ERP, 'erpname', [subject '_ERP_ComAvgRef'], 'filename', [ subject '_ERP_ComAvgRef.erp'], 'filepath',...
 '\\atlas-rstor01.ad.uillinois.edu\research\ELPLab\Experiments\Tone\EEG\ERP_Final\CAR');
end;