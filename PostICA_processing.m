subject_list={'7','8','9','10','11','12','13','14','15'};
numsubjects = length(subject_list);

for s=1:numsubjects;
subject = subject_list{s};
datafolder = '/Users/agnesgao/Dropbox/UCD/PR_EEG/6b_icaed/';

EEG = pop_loadset('filename',['s' subject '_icaed.set'],'filepath',datafolder);


EEG  = pop_artmwppth( EEG , 'Channel', [ 1 2], 'Flag',  1, 'LowPass',  -1, 'Threshold',  100, 'Twindow', [ -200 799], 'Windowsize',  200,...
 'Windowstep',  100 );


%EEG = pop_summary_AR_eeg_detection(EEG, [datafolder '/7_AR/' 's' subject '_AR.txt']);

EEG = pop_eegchanoperator( EEG, {  'nch1 = ch1 - ( .5*ch30 ) Label FP1',  'nch2 = ch2 - ( .5*ch30 ) Label FP2',  'nch3 = ch3 - ( .5*ch30 ) Label F3',...
  'nch4 = ch4 - ( .5*ch30 ) Label F4',  'nch5 = ch5 - ( .5*ch30 ) Label F7',  'nch6 = ch6 - ( .5*ch30 ) Label F8',...
  'nch7 = ch7 - ( .5*ch30 ) Label FC1',  'nch8 = ch8 - ( .5*ch30 ) Label FC2',  'nch9 = ch9 - ( .5*ch30 ) Label FC5',  'nch10 = ch10 - ( .5*ch30 ) Label FC6',...
  'nch11 = ch11 - ( .5*ch30 ) Label C3',  'nch12 = ch12 - ( .5*ch30 ) Label C4',  'nch13 = ch13 - ( .5*ch30 ) Label T3',...
  'nch14 = ch14 - ( .5*ch30 ) Label T4',  'nch15 = ch15 - ( .5*ch30 ) Label CP1',  'nch16 = ch16 - ( .5*ch30 ) Label CP2',  'nch17 = ch17 - ( .5*ch30 ) Label CP5',...
  'nch18 = ch18 - ( .5*ch30 ) Label CP6',  'nch19 = ch19 - ( .5*ch30 ) Label P3',  'nch20 = ch20 - ( .5*ch30 ) Label P4',...
  'nch21 = ch21 - ( .5*ch30 ) Label T5',  'nch22 = ch22 - ( .5*ch30 ) Label T6',  'nch23 = ch23 - ( .5*ch30 ) Label O1',  'nch24 = ch24 - ( .5*ch30 ) Label O2',...
  'nch25 = ch25 - ( .5*ch30 ) Label AFZ',  'nch26 = ch26 - ( .5*ch30 ) Label FZ',  'nch27 = ch27 - ( .5*ch30 ) Label CZ',...
  'nch28 = ch28 - ( .5*ch30 ) Label PZ',  'nch29 = ch29 - ( .5*ch30 ) Label POZ',  'nch30 = ch30 - ( .5*ch30 ) Label LM',  'nch1 = ch1 - ( .5*ch30 ) Label FP1',...
  'nch2 = ch2 - ( .5*ch30 ) Label FP2',  'nch3 = ch3 - ( .5*ch30 ) Label F3',  'nch4 = ch4 - ( .5*ch30 ) Label F4',...
  'nch5 = ch5 - ( .5*ch30 ) Label F7',  'nch6 = ch6 - ( .5*ch30 ) Label F8',  'nch7 = ch7 - ( .5*ch30 ) Label FC1',  'nch8 = ch8 - ( .5*ch30 ) Label FC2',...
  'nch9 = ch9 - ( .5*ch30 ) Label FC5',  'nch10 = ch10 - ( .5*ch30 ) Label FC6',  'nch11 = ch11 - ( .5*ch30 ) Label C3',  'nch12 = ch12 - ( .5*ch30 ) Label C4',...
  'nch13 = ch13 - ( .5*ch30 ) Label T3',  'nch14 = ch14 - ( .5*ch30 ) Label T4',  'nch15 = ch15 - ( .5*ch30 ) Label CP1',...
  'nch16 = ch16 - ( .5*ch30 ) Label CP2',  'nch17 = ch17 - ( .5*ch30 ) Label CP5',  'nch18 = ch18 - ( .5*ch30 ) Label CP6',  'nch19 = ch19 - ( .5*ch30 ) Label P3',...
  'nch20 = ch20 - ( .5*ch30 ) Label P4',  'nch21 = ch21 - ( .5*ch30 ) Label T5',  'nch22 = ch22 - ( .5*ch30 ) Label T6',...
  'nch23 = ch23 - ( .5*ch30 ) Label O1',  'nch24 = ch24 - ( .5*ch30 ) Label O2',  'nch25 = ch25 - ( .5*ch30 ) Label AFZ',...
  'nch26 = ch26 - ( .5*ch30 ) Label FZ',  'nch27 = ch27 - ( .5*ch30 ) Label CZ',  'nch28 = ch28 - ( .5*ch30 ) Label PZ',  'nch29 = ch29 - ( .5*ch30 ) Label POZ'} ,...
 'ErrorMsg', 'popup', 'KeepChLoc', 'on', 'Warning', 'off' );

EEG = pop_saveset( EEG, 'filename',[ 's' subject '_ref.set'],'filepath', '/Users/agnesgao/Dropbox/UCD/PR_EEG/7b_ref/');

ERP = pop_averager( EEG , 'Criterion', 'good', 'DQ_flag', 1, 'SEM', 'on' );

%ERP = pop_filterp( ERP,  1:32 , 'Cutoff',  30, 'Design', 'butter', 'Filter', 'lowpass', 'Order',  6 );

%ERP = pop_binoperator( ERP, {  'bin36=b17-b15 labels    Concreate Unpredicted - Predicted DW',...
%    'bin37=b18-b16 labels Abstract Unpredicted - Predicted DW', 'bin38=b30-b27 labels Long Unpredicted - Predicted DW',...
%    'bin39=bin32-bin29 labels Short Unpredicted - Predicted DW',...
%    'bin40=bin11-bin9 labels High LSA Unpredicted - Predicted DW', 'bin41=bin12-bin10 labels Low LSA Unpredicted - Predicted DW'}); 


ERP = pop_savemyerp(ERP, 'erpname', ['s' subject '_ERP.erp'] , 'filename', ['s' subject '_erp.erp'],...
    'filepath', '/Users/agnesgao/Dropbox/UCD/PR_EEG/8_erp/', 'Warning', 'on');

end;